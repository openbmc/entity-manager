{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "8c167c7b_952d48a8",
        "filename": "/COMMIT_MSG",
        "patchSetId": 11
      },
      "lineNbr": 9,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2025-12-30T19:14:02Z",
      "side": 1,
      "message": "nit: i would recommend 2 things\n\n- add the required log messages / facilities to properly observe the race condition.\n\n- fix the race with reference to before/after of the previously added log messages.\n\nIMO that would make the error and fix easier to understand since the sequence of control flow becomes visible.\n\nWhen there is timers and such, just referencing the code may not be enough for me to understand what\u0027s going wrong for you.",
      "revId": "138769a2a3625b2519d50b5f052400f98a8ef7b0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4bc002d3_636eab0f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 11
      },
      "lineNbr": 9,
      "author": {
        "id": 1002762
      },
      "writtenOn": "2026-01-02T13:35:00Z",
      "side": 1,
      "message": "To reproduce the issue more easily, we run two scripts simultaneously to simulate the scenario described above:\n\n1. One script that execute \u0027ipmi sdr\u0027 every 1 seconds.\n\n2. Another script that issued Fru device rescan via busctl method call every 1 seconds.\n\n1.\n#!/bin/bash\ncycle_count\u003d0\nwhile true; do\n    ((cycle_count++))\n    echo \"[Debug] --- Cycle: $cycle_count | $(date) ---\"\n    echo \"[Debug] $(date): Executing ipmitool sdr...\"\n    echo \"[Debug] --- SDR Information ---\"     \n    ipmitool sdr\n    sleep 1\ndone\n\n2.\n#!/bin/bash\nwhile true; do\necho \"[Debug] Rescan Fru\"\nbusctl call xyz.openbmc_project.FruDevice /xyz/openbmc_project/FruDevice xyz.openbmc_project.FruDeviceManager ReScan;\necho \"[Debug] Sleep 1 sec.\"\nsleep 1\ndone",
      "parentUuid": "8c167c7b_952d48a8",
      "revId": "138769a2a3625b2519d50b5f052400f98a8ef7b0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "79b32e31_8d59edf1",
        "filename": "/COMMIT_MSG",
        "patchSetId": 11
      },
      "lineNbr": 9,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2026-01-03T21:23:37Z",
      "side": 1,
      "message": "\u003e we run two scripts simultaneously to simulate the scenario described above:\n\nnice, that will already help a lot for others to reproduce the issue üëç\n\nIMO it would be great to get the 2 scripts outputs and both debug log outputs of fru device and ipmid service as part of the commit message.",
      "parentUuid": "4bc002d3_636eab0f",
      "revId": "138769a2a3625b2519d50b5f052400f98a8ef7b0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "21562443_5ccbe021",
        "filename": "/COMMIT_MSG",
        "patchSetId": 11
      },
      "lineNbr": 12,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2026-01-06T04:08:58Z",
      "side": 1,
      "message": "This is reading to me as a failure in ipmid.  Can you please point to the failure you\u0027re seeing in ipmid, and we can suggest a fix?",
      "range": {
        "startLine": 12,
        "startChar": 0,
        "endLine": 12,
        "endChar": 70
      },
      "revId": "138769a2a3625b2519d50b5f052400f98a8ef7b0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6c251bbb_c7946467",
        "filename": "/COMMIT_MSG",
        "patchSetId": 11
      },
      "lineNbr": 16,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2026-01-06T04:08:58Z",
      "side": 1,
      "message": "This is expected, and why frudevice has an inotify on i2c devices existing, and a rescan method.",
      "range": {
        "startLine": 14,
        "startChar": 0,
        "endLine": 16,
        "endChar": 16
      },
      "revId": "138769a2a3625b2519d50b5f052400f98a8ef7b0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f42c59d9_cfd8bd36",
        "filename": "/COMMIT_MSG",
        "patchSetId": 11
      },
      "lineNbr": 20,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2026-01-06T04:08:58Z",
      "side": 1,
      "message": "1 second delay shouldn\u0027t even be there;  Can you point to the more specific failure mode you\u0027re seeing?",
      "range": {
        "startLine": 18,
        "startChar": 0,
        "endLine": 20,
        "endChar": 25
      },
      "revId": "138769a2a3625b2519d50b5f052400f98a8ef7b0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d73ef4a1_16b62e1a",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 11
      },
      "lineNbr": 0,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2026-01-06T04:08:58Z",
      "side": 1,
      "message": "Overall this patch is trying to fix bugs in the wrong place.  Please give more detailed failure explanations, and we can suggest a solution.  I very much suspect the fix lies in ipmid retrying an SDR build if the topology changes.",
      "revId": "138769a2a3625b2519d50b5f052400f98a8ef7b0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9ad429f0_eee11200",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 11
      },
      "lineNbr": 1228,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2025-12-30T19:14:02Z",
      "side": 1,
      "message": "IMO things like timeouts should be parameters to the implementation.\n\nWe should not hardcode them since they are arbitrary and may need to be lower in integration test scenario.\n\nLet\u0027s pass the timeout as parameter.",
      "revId": "138769a2a3625b2519d50b5f052400f98a8ef7b0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "73963f34_4ca46a52",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 11
      },
      "lineNbr": 1228,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2026-01-06T04:08:58Z",
      "side": 1,
      "message": "\u003e IMO things like timeouts should be parameters to the implementation.\n\nDisagree here.  This timeout should ideally just not exist.  I\u0027d rather fix it than promote to make it seem like it\u0027s anything more than a hack to work around a bug.\n\n\u003e \n\u003e We should not hardcode them since they are arbitrary and may need to be lower in integration test scenario.\n\u003e \n\u003e Let\u0027s pass the timeout as parameter.\n\nNope, Code is fine as is.",
      "parentUuid": "9ad429f0_eee11200",
      "revId": "138769a2a3625b2519d50b5f052400f98a8ef7b0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f940264b_022a2655",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 11
      },
      "lineNbr": 1243,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2025-12-30T19:14:02Z",
      "side": 1,
      "message": "How does this (and the other diff below)\nfix the issue? The control flow is still the same as before.\n\nThe file here is not a lock file since the control flow does not change,\nonly the log messages are different.",
      "revId": "138769a2a3625b2519d50b5f052400f98a8ef7b0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c5473278_aed29955",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 11
      },
      "lineNbr": 1243,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2025-12-30T19:14:02Z",
      "side": 1,
      "message": "Why do we need a file for locking within the same process?",
      "revId": "138769a2a3625b2519d50b5f052400f98a8ef7b0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "33e31520_d30d9071",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 11
      },
      "lineNbr": 1243,
      "author": {
        "id": 1002762
      },
      "writtenOn": "2026-01-02T13:35:00Z",
      "side": 1,
      "message": "The control flow change is in ipmid: SDR access is now blocked based on\nthis signal, which did not exist before.\nRelated other changes: https://gerrit.openbmc.org/c/openbmc/phosphor-host-ipmid/+/86329",
      "parentUuid": "f940264b_022a2655",
      "revId": "138769a2a3625b2519d50b5f052400f98a8ef7b0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "85972b21_67c2706c",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 11
      },
      "lineNbr": 1243,
      "author": {
        "id": 1002762
      },
      "writtenOn": "2026-01-02T13:35:00Z",
      "side": 1,
      "message": "This lock is not used for synchronization within the same process.\nIt serves as a lightweight, cross-service indicator to signal that a\nFRU rescan is in progress. Other services (such as ipmid) check for this\nfile to avoid accessing FRU-related D-Bus objects while they are being\nremoved and recreated.\n\nRelated other changes: https://gerrit.openbmc.org/c/openbmc/phosphor-host-ipmid/+/86329",
      "parentUuid": "c5473278_aed29955",
      "revId": "138769a2a3625b2519d50b5f052400f98a8ef7b0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "43c7dd06_5e1ca837",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 11
      },
      "lineNbr": 1243,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2026-01-03T21:23:37Z",
      "side": 1,
      "message": "\u003e Related other changes\n\nCan you please add the link to that other change to the commit message and set the gerrit topic.\n\n\u003e Other services (such as ipmid) check for this\nfile\n\nI am wondering why we use a file to implement the lock, did you consider implementing it via DBus? From my perspective DBus seems to be the preferred IPC mechanism.\n\nhttps://github.com/openbmc/docs/blob/224f278c74a574962a74a7498a86989a360666ea/CONTRIBUTING.md?plain\u003d1#L24C1-L26C50\n\n\u003e OpenBMC has quite a modular structure, consisting of small daemons with a\nlimited set of responsibilities. These communicate over D-Bus with other\ncomponents, to implement the complete BMC system.",
      "parentUuid": "85972b21_67c2706c",
      "revId": "138769a2a3625b2519d50b5f052400f98a8ef7b0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fa2e2f67_66f19670",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 11
      },
      "lineNbr": 1243,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2026-01-03T21:23:37Z",
      "side": 1,
      "message": "Looking at\n\nhttps://gerrit.openbmc.org/c/openbmc/phosphor-host-ipmid/+/86329/2\n\ni imagine following scenario\n\n- lock file does not exist\n- ipmid looks for lock file, does not find it\n- ipmid proceeds with SDR scan (instruction pointer is around line 2479)\n\n- fru device creates the lock file\n- fru device updates it\u0027s DBus interfaces\n\n- ipmid fails it\u0027s SDR scan\n\n- fru device removes lock file\n\nIs it possible with your changes?",
      "parentUuid": "33e31520_d30d9071",
      "revId": "138769a2a3625b2519d50b5f052400f98a8ef7b0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ec9dc8a0_44e0683f",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 11
      },
      "lineNbr": 1243,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2026-01-06T04:08:58Z",
      "side": 1,
      "message": "\u003e Other services (such as ipmid) check for this\nfile to avoid accessing FRU-related D-Bus objects while they are being\nremoved and recreated.\n\n\nThis isn\u0027t a solution.  DBus objects are supposed to be created and destroyed atomically.  If ipmid isn\u0027t handling that, or fru device isn\u0027t correctly creating thing atomically, that\u0027s the thing to fix.  Adding another IPC is not something I want to support.",
      "parentUuid": "43c7dd06_5e1ca837",
      "revId": "138769a2a3625b2519d50b5f052400f98a8ef7b0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "03789798_7a45dd2c",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 11
      },
      "lineNbr": 1253,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2025-12-30T19:14:02Z",
      "side": 1,
      "message": "`lg2::error`",
      "revId": "138769a2a3625b2519d50b5f052400f98a8ef7b0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a0f51bcd_64a48883",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 11
      },
      "lineNbr": 1253,
      "author": {
        "id": 1002762
      },
      "writtenOn": "2026-01-02T13:35:00Z",
      "side": 1,
      "message": "Understood. I will update this to use lg2 logging, with info-level logs\nfor successful lock removal and error-level logs only for failure cases.",
      "parentUuid": "03789798_7a45dd2c",
      "revId": "138769a2a3625b2519d50b5f052400f98a8ef7b0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d5e0b3b9_723a5198",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 11
      },
      "lineNbr": 1316,
      "author": {
        "id": 1002631
      },
      "writtenOn": "2026-01-06T03:56:27Z",
      "side": 1,
      "message": "please update lg2 here aswell",
      "revId": "138769a2a3625b2519d50b5f052400f98a8ef7b0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f0259ae2_3ab595e9",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 11
      },
      "lineNbr": 1323,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2026-01-06T04:08:58Z",
      "side": 1,
      "message": "as implemented this code doesn\u0027t handle all errors, and the file could be created and deadlock.",
      "revId": "138769a2a3625b2519d50b5f052400f98a8ef7b0",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    }
  ]
}