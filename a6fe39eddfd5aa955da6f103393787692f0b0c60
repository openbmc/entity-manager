{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "702f91e9_fb2b3786",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 3
      },
      "lineNbr": 1051,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2025-10-02T21:10:57Z",
      "side": 1,
      "message": "capturing by \"this\" alone in a lambda context isn\u0027t safe.  Probably need to do the shared_from_this trick?  Or make scan somehow outlive the lifetime of FruDevice",
      "range": {
        "startLine": 1051,
        "startChar": 21,
        "endLine": 1051,
        "endChar": 25
      },
      "revId": "a6fe39eddfd5aa955da6f103393787692f0b0c60",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "50ca1f5c_4f3d9d99",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 3
      },
      "lineNbr": 1051,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2025-10-06T11:57:13Z",
      "side": 1,
      "message": "`FruDevice` instance is in scope from beginning to end of `main` function.\n\nYou are right in a generic C++ context but in our particular case `FruDevice` is a singleton in the application context.\n\nAnd when `FruDevice` instance goes out of scope we are already at the point where `fruDevice.io.run()` returns so there should not be any other code running beyond that point.\n\nI am kind of stuck here as from a local reasoning perspective your suggestion is better but i would like to avoid introducing any `shared_ptr` for `FruDevice` instance since we know it\u0027s lifetime already (thus no need for `shared_ptr`).\n\nSo both choices are wrong and because of that i would like to go with the simpler choice (no `shared_ptr`).",
      "parentUuid": "702f91e9_fb2b3786",
      "range": {
        "startLine": 1051,
        "startChar": 21,
        "endLine": 1051,
        "endChar": 25
      },
      "revId": "a6fe39eddfd5aa955da6f103393787692f0b0c60",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "05d9c2a7_1f5e3f1a",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 3
      },
      "lineNbr": 1051,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2025-10-13T13:59:34Z",
      "side": 1,
      "message": "Closing this discussion thread since there\u0027s been no further response in a week.\n\nI would really like to avoid introducing additional `shared_ptr` if we can somehow avoid it.",
      "parentUuid": "50ca1f5c_4f3d9d99",
      "range": {
        "startLine": 1051,
        "startChar": 21,
        "endLine": 1051,
        "endChar": 25
      },
      "revId": "a6fe39eddfd5aa955da6f103393787692f0b0c60",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bdb707c8_ee6130ea",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 3
      },
      "lineNbr": 1051,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2025-11-03T20:47:23Z",
      "side": 1,
      "message": "\u003e `FruDevice` instance is in scope from beginning to end of `main` function.\n\nAt this scope, that\u0027s not gauranteed that FruDevice and io_context are in the same scope, which leads to subtle bugs.\n\n\u003e \n\u003e You are right in a generic C++ context but in our particular case `FruDevice` is a singleton in the application context.\n\nMaybe I\u0027m not understanding the term here.  This isn\u0027t a singleton, this is a stack variable declared in main, right?  \n\n\u003e \n\u003e And when `FruDevice` instance goes out of scope we are already at the point where `fruDevice.io.run()` returns so there should not be any other code running beyond that point.\n\nRight... this is the point, there\u0027s no guarantee of this within the class, which leads to subtle bugs.  FWIW, that\u0027s somewhat why these were globals initially and not on stack.\n\n\u003e \n\u003e I am kind of stuck here as from a local reasoning perspective your suggestion is better but i would like to avoid introducing any `shared_ptr` for `FruDevice` instance since we know it\u0027s lifetime already (thus no need for `shared_ptr`).\n\u003e \n\u003e So both choices are wrong and because of that i would like to go with the simpler choice (no `shared_ptr`).",
      "parentUuid": "50ca1f5c_4f3d9d99",
      "range": {
        "startLine": 1051,
        "startChar": 21,
        "endLine": 1051,
        "endChar": 25
      },
      "revId": "a6fe39eddfd5aa955da6f103393787692f0b0c60",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "27fc9c6a_7a6e38a3",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 3
      },
      "lineNbr": 1051,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2025-11-04T09:40:05Z",
      "side": 1,
      "message": "\u003e Maybe I\u0027m not understanding the term here. This isn\u0027t a singleton, this is a stack variable declared in main, right? \n\nThere\u0027s only ever a single instance of `FruDevice` class in the application.\n~\u003e singleton.\n\nhttps://en.wikipedia.org/wiki/Singleton_pattern\n\n\u003e In object-oriented programming, the singleton pattern is a software design pattern that restricts the instantiation of a class to a singular instance\n\nI did not put a mechanism in the class to enforce it as singleton because i consider it to be obvious from looking at the usage within the application context.\n\n\n\u003e Right... this is the point, there\u0027s no guarantee of this within the class, which leads to subtle bugs. FWIW, that\u0027s somewhat why these were globals initially and not on stack.\n\nAnd global vars accessible from any function which can see them does not lead to subtle bugs?",
      "parentUuid": "bdb707c8_ee6130ea",
      "range": {
        "startLine": 1051,
        "startChar": 21,
        "endLine": 1051,
        "endChar": 25
      },
      "revId": "a6fe39eddfd5aa955da6f103393787692f0b0c60",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9840b90b_7088565e",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 3
      },
      "lineNbr": 1051,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2025-11-07T13:35:48Z",
      "side": 1,
      "message": "I posed the question about the general problem (is it ok to pass plain references to singleton objects) on discord\nhttps://discordapp.com/channels/775381525260664832/867820390406422538/1436347622771130545\nto get some more input on it.",
      "parentUuid": "27fc9c6a_7a6e38a3",
      "range": {
        "startLine": 1051,
        "startChar": 21,
        "endLine": 1051,
        "endChar": 25
      },
      "revId": "a6fe39eddfd5aa955da6f103393787692f0b0c60",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "16f23d1a_b4369b5f",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 3
      },
      "lineNbr": 1051,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2025-11-07T17:06:13Z",
      "side": 1,
      "message": "I have moved to `shared_ptr` as suggested based on feedback received in discord.",
      "parentUuid": "9840b90b_7088565e",
      "range": {
        "startLine": 1051,
        "startChar": 21,
        "endLine": 1051,
        "endChar": 25
      },
      "revId": "a6fe39eddfd5aa955da6f103393787692f0b0c60",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "442e03e9_0572740c",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 3
      },
      "lineNbr": 1439,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2025-10-02T21:10:57Z",
      "side": 1,
      "message": "io_context should be shared separately from the fru portions itself.  this directory watcher really should know nothign about what a \"fru\" is ideally.",
      "range": {
        "startLine": 1439,
        "startChar": 51,
        "endLine": 1439,
        "endChar": 60
      },
      "revId": "a6fe39eddfd5aa955da6f103393787692f0b0c60",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d780ac89_4436e334",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 3
      },
      "lineNbr": 1439,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2025-10-06T11:57:13Z",
      "side": 1,
      "message": "Yes but it was like that before with the global variables due to the wildcard capture. So i am not changing things here.\n\nHaving a class enables us to have encapsulation and do some OOP design but we don\u0027t necessarily have to do that right now.\n\nIf we start the fine grained encapsulation now we might open up some rabbit hole leading to further work which could bloat the diff and make this change harder to review.",
      "parentUuid": "442e03e9_0572740c",
      "range": {
        "startLine": 1439,
        "startChar": 51,
        "endLine": 1439,
        "endChar": 60
      },
      "revId": "a6fe39eddfd5aa955da6f103393787692f0b0c60",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "6e5199bd_178e68e8",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 3
      },
      "lineNbr": 1439,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2025-10-13T13:59:34Z",
      "side": 1,
      "message": "closing this discussion thread since there\u0027s been no further response in a week.",
      "parentUuid": "d780ac89_4436e334",
      "range": {
        "startLine": 1439,
        "startChar": 51,
        "endLine": 1439,
        "endChar": 60
      },
      "revId": "a6fe39eddfd5aa955da6f103393787692f0b0c60",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3f7a1ab9_53f61c05",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 3
      },
      "lineNbr": 1439,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2025-11-03T20:47:23Z",
      "side": 1,
      "message": "\u003e So i am not changing things here.\n\nYou\u0027ve created the FruDevice class, so you\u0027ve changed things.\n\nThe goal is not \"fine grained\" the goal is simplicity.  As written, now every API within fru device now could potentially be called from inotify.  At least with the global we have one variable.",
      "parentUuid": "d780ac89_4436e334",
      "range": {
        "startLine": 1439,
        "startChar": 51,
        "endLine": 1439,
        "endChar": 60
      },
      "revId": "a6fe39eddfd5aa955da6f103393787692f0b0c60",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6ba55953_f8225a15",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 3
      },
      "lineNbr": 1439,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2025-11-04T09:40:05Z",
      "side": 1,
      "message": "\u003e At least with the global we have one variable.\n\n```\n  // TODO Refactor these to not be globals\n  // NOLINTBEGIN(cppcoreguidelines-avoid-non-const-global-variables)\n  static boost::container::flat_map\u003csize_t, std::optional\u003cstd::set\u003csize_t\u003e\u003e\u003e\n      busBlocklist;\n  struct FindDevicesWithCallback;\n      \n  static boost::container::flat_map\u003c\n      std::pair\u003csize_t, size_t\u003e, std::shared_ptr\u003csdbusplus::asio::dbus_interface\u003e\u003e\n      foundDevices;\n      \n  static boost::container::flat_map\u003csize_t, std::set\u003csize_t\u003e\u003e failedAddresses;\n  static boost::container::flat_map\u003csize_t, std::set\u003csize_t\u003e\u003e fruAddresses;\n  \n  boost::asio::io_context io;\n  // NOLINTEND(cppcoreguidelines-avoid-non-const-global-variables)\n```\n\nWe have around 6 global vars? (which are btw annotated as TODO for rework)\n\n\n\u003e As written, now every API within fru device now could potentially be called from inotify.\n\nThis patch is a basic rework. It\u0027s not meant to be the pinnacle of encapsulation.\n\nIt\u0027s meant to get us started in a direction where we can define proper encapsulation via `public` and `private` member variables and member functions.",
      "parentUuid": "3f7a1ab9_53f61c05",
      "range": {
        "startLine": 1439,
        "startChar": 51,
        "endLine": 1439,
        "endChar": 60
      },
      "revId": "a6fe39eddfd5aa955da6f103393787692f0b0c60",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "cd46e306_105c3390",
        "filename": "src/fru_device/fru_device.cpp",
        "patchSetId": 3
      },
      "lineNbr": 1439,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2025-11-07T17:06:13Z",
      "side": 1,
      "message": "\u003e io_context should be shared separately from the fru portions itself. this directory watcher really should know nothign about what a \"fru\" is ideally.\n\nDone, FruDevice now only stores a reference to io context. Sorry for getting stuck on this detail.",
      "parentUuid": "6ba55953_f8225a15",
      "range": {
        "startLine": 1439,
        "startChar": 51,
        "endLine": 1439,
        "endChar": 60
      },
      "revId": "a6fe39eddfd5aa955da6f103393787692f0b0c60",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fc6ea720_77db3ac8",
        "filename": "src/fru_device/fru_device.hpp",
        "patchSetId": 3
      },
      "lineNbr": 17,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2025-10-02T21:10:57Z",
      "side": 1,
      "message": "Should this just be owned within FruUtils?  Passing in a reference (even const) worries me that we\u0027ll get lifetime issues.",
      "range": {
        "startLine": 17,
        "startChar": 0,
        "endLine": 17,
        "endChar": 18
      },
      "revId": "a6fe39eddfd5aa955da6f103393787692f0b0c60",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a02bfdbf_c2b628bb",
        "filename": "src/fru_device/fru_device.hpp",
        "patchSetId": 3
      },
      "lineNbr": 17,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2025-10-06T11:57:13Z",
      "side": 1,
      "message": "Sure. We can reach it via the class member then and do not need a reference anymore.",
      "parentUuid": "fc6ea720_77db3ac8",
      "range": {
        "startLine": 17,
        "startChar": 0,
        "endLine": 17,
        "endChar": 18
      },
      "revId": "a6fe39eddfd5aa955da6f103393787692f0b0c60",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "dc8f992a_2216fa02",
        "filename": "src/fru_device/fru_device.hpp",
        "patchSetId": 3
      },
      "lineNbr": 30,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2025-10-02T21:10:57Z",
      "side": 1,
      "message": "THis is a busmap reference, not a busmap.",
      "range": {
        "startLine": 30,
        "startChar": 34,
        "endLine": 30,
        "endChar": 40
      },
      "revId": "a6fe39eddfd5aa955da6f103393787692f0b0c60",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9a4b9837_af0c4bbf",
        "filename": "src/fru_device/fru_device.hpp",
        "patchSetId": 3
      },
      "lineNbr": 30,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2025-10-06T11:57:13Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "dc8f992a_2216fa02",
      "range": {
        "startLine": 30,
        "startChar": 34,
        "endLine": 30,
        "endChar": 40
      },
      "revId": "a6fe39eddfd5aa955da6f103393787692f0b0c60",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8413d248_1f5a4ca7",
        "filename": "src/fru_device/fru_utils.hpp",
        "patchSetId": 3
      },
      "lineNbr": 31,
      "author": {
        "id": 1000153
      },
      "writtenOn": "2025-10-02T21:10:57Z",
      "side": 1,
      "message": "See above, should this just be owned within the class?",
      "range": {
        "startLine": 31,
        "startChar": 0,
        "endLine": 31,
        "endChar": 25
      },
      "revId": "a6fe39eddfd5aa955da6f103393787692f0b0c60",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fb8ed81d_2e257ce5",
        "filename": "src/fru_device/fru_utils.hpp",
        "patchSetId": 3
      },
      "lineNbr": 31,
      "author": {
        "id": 1001712
      },
      "writtenOn": "2025-10-06T11:57:13Z",
      "side": 1,
      "message": "Changed it to be stored here.",
      "parentUuid": "8413d248_1f5a4ca7",
      "range": {
        "startLine": 31,
        "startChar": 0,
        "endLine": 31,
        "endChar": 25
      },
      "revId": "a6fe39eddfd5aa955da6f103393787692f0b0c60",
      "serverId": "adbd0a64-1f21-4d83-b585-671fe73cb6e4"
    }
  ]
}